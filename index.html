<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Notebook IA</title>
    
    <!-- Librerías de Estilo y Funcionalidad -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { 
            background-color: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-press:active { transform: scale(0.96); opacity: 0.8; }
        .spinner { border: 3px solid rgba(0,0,0,0.05); border-top-color: var(--ios-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .mermaid svg { width: 100% !important; height: auto !important; border-radius: 12px; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- Pantalla de Inicio (Lista de Cuadernos) -->
    <div id="view-home" class="min-h-screen pb-32">
        <header class="p-6 pt-16 flex justify-between items-end">
            <div>
                <p class="text-blue-600 font-bold text-xs uppercase tracking-widest mb-1">Tu Biblioteca</p>
                <h1 class="text-4xl font-black tracking-tight">Cuadernos</h1>
            </div>
            <button onclick="ui.createNotebook()" class="bg-blue-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg btn-press">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
            </button>
        </header>
        <div id="notebooks-list" class="px-6 space-y-4">
            <!-- Los cuadernos se renderizan aquí -->
        </div>
    </div>

    <!-- Vista Detalle (Páginas del Cuaderno) -->
    <div id="view-detail" class="hidden min-h-screen pb-40">
        <nav class="sticky top-0 glass border-b border-slate-100 px-4 py-4 flex items-center justify-between z-50">
            <button onclick="ui.showHome()" class="text-blue-600 font-bold flex items-center btn-press">
                <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                Volver
            </button>
            <h2 id="current-notebook-title" class="font-bold truncate px-4 max-w-[150px]">Nombre</h2>
            <div class="w-10"></div>
        </nav>
        <div id="pages-list" class="p-4 space-y-6">
            <!-- Las páginas se renderizan aquí -->
        </div>
        
        <!-- Controles de captura en la parte inferior -->
        <div class="fixed bottom-0 left-0 right-0 p-6 glass border-t border-slate-200/50 flex space-x-3 safe-bottom z-40">
            <label class="flex-1 bg-white border border-slate-200 text-slate-700 h-14 rounded-2xl flex items-center justify-center font-bold shadow-sm btn-press cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Archivos
                <input type="file" multiple accept="image/*" class="hidden" onchange="ia.processBatch(this.files)">
            </label>
            <label class="flex-1 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center font-bold shadow-xl btn-press cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
                Cámara
                <input type="file" capture="environment" accept="image/*" class="hidden" onchange="ia.processBatch(this.files)">
            </label>
        </div>
    </div>

    <!-- Overlay de Procesamiento IA -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[200] hidden flex items-center justify-center p-6 text-center">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-xs space-y-5">
            <div class="spinner mx-auto !w-12 !h-12 !border-4"></div>
            <div>
                <h3 class="font-bold text-xl">IA Analizando</h3>
                <p class="text-slate-400 text-sm mt-1">Hoja <span id="p-cur">0</span> de <span id="p-tot">0</span></p>
            </div>
            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                <div id="p-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <p id="p-status" class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">Separando Texto y Formas</p>
        </div>
    </div>

    <script>
        // --- MOTOR DE DATOS (LocalStorage) ---
        const db = {
            save(data) { localStorage.setItem('notebook_ia_data', JSON.stringify(data)); },
            load() { return JSON.parse(localStorage.getItem('notebook_ia_data')) || { notebooks: [] }; }
        };

        let appData = db.load();
        let currentNotebookId = null;

        // --- MOTOR IA (Gemini 2.5 Flash) ---
        const apiKey = ""; // La API key se inyecta en el entorno de ejecución
        
        window.ia = {
            async processBatch(filesList) {
                const files = Array.from(filesList);
                if (!files.length || !currentNotebookId) return;

                const overlay = document.getElementById('loading-overlay');
                overlay.classList.remove('hidden');
                document.getElementById('p-tot').innerText = files.length;

                for (let i = 0; i < files.length; i++) {
                    const current = i + 1;
                    document.getElementById('p-cur').innerText = current;
                    document.getElementById('p-bar').style.width = (current / files.length * 100) + '%';
                    
                    try {
                        const b64 = await this.toBase64(files[i]);
                        const analysis = await this.callGemini(b64.split(',')[1]);
                        this.savePage(analysis, b64);
                    } catch (e) {
                        console.error("Error en página " + current, e);
                        alert("Error procesando la página " + current);
                    }
                }
                overlay.classList.add('hidden');
                ui.renderPages();
            },

            async callGemini(base64Data, retries = 5) {
                const prompt = "Analiza esta imagen escaneada: 1. Extrae todo el texto manuscrito y pásalo a Markdown. 2. Si hay dibujos, diagramas o esquemas, conviértelos a código Mermaid.js preciso. Devuelve estrictamente un objeto JSON con llaves 'texto' y 'mermaid'. No devuelvas texto adicional.";
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Data } }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                        
                        if (res.ok) {
                            const json = await res.json();
                            return JSON.parse(json.candidates[0].content.parts[0].text);
                        }
                    } catch (e) {}
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
                throw new Error("La IA no responde tras varios intentos");
            },

            savePage(data, image) {
                const notebook = appData.notebooks.find(n => n.id === currentNotebookId);
                notebook.pages.unshift({
                    id: Date.now() + Math.random(),
                    texto: data.texto,
                    mermaid: data.mermaid || "",
                    image: image,
                    date: new Date().toLocaleString()
                });
                db.save(appData);
            },

            toBase64: (file) => new Promise(res => {
                const r = new FileReader();
                r.onload = () => res(r.result);
                r.readAsDataURL(file);
            })
        };

        // --- INTERFAZ DE USUARIO ---
        window.ui = {
            showHome() {
                currentNotebookId = null;
                document.getElementById('view-detail').classList.add('hidden');
                document.getElementById('view-home').classList.remove('hidden');
                this.renderNotebooks();
            },

            showDetail(id) {
                currentNotebookId = id;
                const nb = appData.notebooks.find(n => n.id === id);
                document.getElementById('current-notebook-title').innerText = nb.name;
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-detail').classList.remove('hidden');
                this.renderPages();
            },

            createNotebook() {
                const name = prompt("Nombre del nuevo cuaderno:");
                if (!name) return;
                const newNb = { id: Date.now(), name, pages: [] };
                appData.notebooks.unshift(newNb);
                db.save(appData);
                this.renderNotebooks();
            },

            deleteNotebook(id, e) {
                e.stopPropagation();
                if (!confirm("¿Eliminar este cuaderno?")) return;
                appData.notebooks = appData.notebooks.filter(n => n.id !== id);
                db.save(appData);
                this.renderNotebooks();
            },

            deletePage(pageId) {
                if (!confirm("¿Eliminar esta página?")) return;
                const nb = appData.notebooks.find(n => n.id === currentNotebookId);
                nb.pages = nb.pages.filter(p => p.id !== pageId);
                db.save(appData);
                this.renderPages();
            },

            sharePage(pageId) {
                const nb = appData.notebooks.find(n => n.id === currentNotebookId);
                const p = nb.pages.find(pg => pg.id === pageId);
                if (navigator.share) {
                    navigator.share({ title: 'Escaneo IA', text: p.texto });
                } else {
                    alert("Copiado al portapapeles: " + p.texto.substring(0, 50) + "...");
                }
            },

            renderNotebooks() {
                const cont = document.getElementById('notebooks-list');
                if (!appData.notebooks.length) {
                    cont.innerHTML = `<div class="p-12 text-center text-slate-400 font-medium">No hay cuadernos aún.<br>Crea uno para empezar.</div>`;
                    return;
                }
                cont.innerHTML = appData.notebooks.map(nb => `
                    <div onclick="ui.showDetail(${nb.id})" class="ios-card p-5 flex items-center justify-between btn-press">
                        <div class="flex items-center space-x-4 text-slate-800">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center font-bold">NB</div>
                            <div>
                                <h3 class="font-bold text-lg">${nb.name}</h3>
                                <p class="text-xs text-slate-400">${nb.pages.length} páginas</p>
                            </div>
                        </div>
                        <button onclick="ui.deleteNotebook(${nb.id}, event)" class="text-slate-200 hover:text-red-500"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg></button>
                    </div>
                `).join('');
            },

            renderPages() {
                const cont = document.getElementById('pages-list');
                const nb = appData.notebooks.find(n => n.id === currentNotebookId);
                if (!nb.pages.length) {
                    cont.innerHTML = `<div class="py-20 text-center text-slate-400">Escanea o sube imágenes para este cuaderno.</div>`;
                    return;
                }
                cont.innerHTML = nb.pages.map(p => `
                    <div class="ios-card overflow-hidden">
                        <img src="${p.image}" class="w-full h-40 object-cover border-b border-slate-50 opacity-80 grayscale hover:grayscale-0 transition-all">
                        <div class="p-6">
                            <div class="prose prose-sm text-slate-700 mb-6 font-medium">${marked.parse(p.texto)}</div>
                            ${p.mermaid ? `<div class="bg-slate-50 p-4 rounded-xl mb-4 overflow-x-auto"><pre class="mermaid">${p.mermaid}</pre></div>` : ''}
                            <div class="flex space-x-2">
                                <button onclick="ui.sharePage(${p.id})" class="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-sm btn-press">Compartir</button>
                                <button onclick="ui.deletePage(${p.id})" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center btn-press"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Renderizado de diagramas Mermaid
                if (nb.pages.some(p => p.mermaid)) {
                    mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
                }
            }
        };

        // --- INICIO ---
        mermaid.initialize({ startOnLoad: false, theme: 'default' });
        ui.renderNotebooks();

    </script>
</body>
</html>

