<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Digitaliza tus cuadernos con IA - Extrae texto y diagramas autom√°ticamente">
    <meta name="theme-color" content="#007AFF">
    <link rel="manifest" href="manifest.json">
    <title>Scanner IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; }
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .ios-card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-active:active { transform: scale(0.96); opacity: 0.7; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--ios-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .mermaid svg { width: 100% !important; height: auto !important; }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

```
<!-- Modal de configuraci√≥n de API Key -->
<div id="api-key-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[300] flex items-center justify-center p-6">
    <div class="bg-white rounded-3xl p-8 w-full max-w-md space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">Configuraci√≥n de API</h2>
            <p class="text-slate-500 text-sm">Necesitas una API Key de Google Gemini para usar la IA</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">API Key de Gemini</label>
                <input 
                    type="password" 
                    id="api-key-input" 
                    placeholder="AIzaSy..." 
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none"
                >
                <p class="text-xs text-slate-400 mt-2">
                    Obt√©n tu clave en: 
                    <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a>
                </p>
            </div>
            
            <button 
                onclick="app.saveApiKey()" 
                class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold btn-active"
            >
                Guardar y Continuar
            </button>
            
            <button 
                onclick="app.useDemoMode()" 
                class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold btn-active text-sm"
            >
                Usar Modo Demo (sin IA real)
            </button>
        </div>
    </div>
</div>

<!-- Pantalla de Diagn√≥stico e Inicio -->
<div id="setup-screen" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-8 transition-all duration-500 hidden">
    <div id="loader-icon" class="spinner mb-6"></div>
    <h1 class="text-2xl font-bold mb-2">Iniciando Esc√°ner</h1>
    <p id="setup-status" class="text-slate-500 text-center text-sm mb-6">Conectando con el cerebro de la IA...</p>
    
    <div id="diagnostic-box" class="w-full max-w-xs bg-slate-50 rounded-xl p-4 font-mono text-[10px] text-slate-400 mb-6">
        <div id="diag-auth">‚óè Auth: Listo</div>
        <div id="diag-db">‚óè Base de datos: Lista</div>
        <div id="diag-ia">‚óè Motor IA: Esperando...</div>
    </div>

    <button id="btn-emergency" onclick="app.startAnyway()" class="px-6 py-3 bg-slate-100 text-slate-600 rounded-full font-bold text-sm btn-active">
        Entrar de todos modos
    </button>
</div>

<!-- App Principal -->
<div id="main-app" class="hidden min-h-screen pb-32">
    
    <!-- Vista: Biblioteca -->
    <div id="view-home" class="view">
        <header class="p-6 pt-16 flex justify-between items-end">
            <div>
                <h2 class="text-blue-600 font-bold text-xs uppercase tracking-widest mb-1">Mis Escaneos</h2>
                <h1 class="text-4xl font-black tracking-tight">Cuadernos</h1>
            </div>
            <button onclick="app.newNotebook()" class="bg-blue-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg btn-active">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
            </button>
        </header>
        <div id="notebooks-grid" class="px-6 space-y-4"></div>
    </div>

    <!-- Vista: Cuaderno Detalle -->
    <div id="view-detail" class="view hidden">
        <nav class="sticky top-0 glass border-b border-slate-100 px-4 py-4 flex items-center justify-between z-50">
            <button onclick="app.goHome()" class="text-blue-600 font-bold flex items-center btn-active">
                <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                Volver
            </button>
            <h2 id="nb-title" class="font-bold text-slate-800 truncate px-4">Cuaderno</h2>
            <button onclick="app.showApiKeyModal()" class="p-2 text-slate-400 hover:text-blue-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </nav>
        <div id="pages-list" class="p-4 space-y-6"></div>
        
        <!-- Controles de captura -->
        <div class="fixed bottom-0 left-0 right-0 p-6 glass border-t border-slate-200/50 flex space-x-3 pb-10">
            <label class="flex-1 bg-white border border-slate-200 text-slate-700 h-14 rounded-2xl flex items-center justify-center font-bold shadow-sm btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Galer√≠a
                <input type="file" multiple accept="image/*" class="hidden" onchange="app.processFiles(this.files)">
            </label>
            <label class="flex-1 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center font-bold shadow-xl btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
                C√°mara
                <input type="file" capture="environment" accept="image/*" class="hidden" onchange="app.processFiles(this.files)">
            </label>
        </div>
    </div>
</div>

<!-- Overlay de carga IA -->
<div id="ia-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6 text-center">
    <div class="bg-white rounded-[32px] p-8 w-full max-w-xs space-y-4">
        <div class="spinner mx-auto !w-12 !h-12 !border-4"></div>
        <h3 class="font-bold text-xl">Digitalizando...</h3>
        <p class="text-slate-400 text-sm">Procesando p√°gina <span id="ia-cur">0</span> de <span id="ia-tot">0</span></p>
        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
            <div id="ia-progress" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
        </div>
    </div>
</div>

<script type="module">
    // Estado de la aplicaci√≥n
    let apiKey = null;
    let demoMode = false;
    let activeNbId = null;
    let notebooks = [];
    let pages = [];

    // Datos en memoria
    const mockData = {
        notebooks: [],
        pages: {}
    };

    // Herramientas de diagn√≥stico
    const updateDiag = (id, text, color) => {
        const el = document.getElementById('diag-'+id);
        if (el) {
            el.innerText = `‚óè ${text}`;
            el.className = color;
        }
    };

    // --- L√ìGICA DE LA APLICACI√ìN ---
    window.app = {
        async init() {
            // Verificar si ya hay una API key guardada
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                apiKey = savedKey;
                this.hideApiKeyModal();
                await this.testApiKey();
            }
        },

        showApiKeyModal() {
            document.getElementById('api-key-modal').classList.remove('hidden');
        },

        hideApiKeyModal() {
            document.getElementById('api-key-modal').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        },

        async saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            
            if (!key) {
                alert('Por favor ingresa una API Key v√°lida');
                return;
            }
            
            apiKey = key;
            localStorage.setItem('gemini_api_key', key);
            this.hideApiKeyModal();
            await this.testApiKey();
        },

        async testApiKey() {
            updateDiag('ia', 'Verificando API Key...', 'text-yellow-500');
            
            try {
                // Primero intentamos listar los modelos disponibles (m√°s ligero)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Modelos disponibles:', data.models?.map(m => m.name));
                    updateDiag('ia', 'Motor IA conectado ‚úì', 'text-green-500');
                    demoMode = false;
                } else {
                    const errorData = await response.json();
                    console.error('Error de API:', errorData);
                    throw new Error(errorData.error?.message || 'API Key inv√°lida');
                }
            } catch (e) {
                console.error('Error completo:', e);
                updateDiag('ia', 'Error: ' + e.message, 'text-red-500');
                
                // Si hay error de red, pero la key parece v√°lida (formato correcto), permitir continuar
                if (apiKey && apiKey.startsWith('AIzaSy') && apiKey.length > 30) {
                    const continuar = confirm(`No se pudo verificar la API Key (${e.message}). ¬øQuieres continuar de todos modos? La key ser√° verificada cuando uses la IA.`);
                    if (continuar) {
                        updateDiag('ia', 'Motor IA (sin verificar)', 'text-yellow-500');
                        demoMode = false;
                        this.loadNotebooks();
                        setTimeout(() => this.startAnyway(), 500);
                        return;
                    }
                }
                
                alert('La API Key no es v√°lida o hay un problema de conexi√≥n. Verifica tu clave en Google AI Studio.');
                localStorage.removeItem('gemini_api_key');
                apiKey = null;
                this.showApiKeyModal();
                return;
            }
            
            this.loadNotebooks();
            setTimeout(() => this.startAnyway(), 1000);
        },

        useDemoMode() {
            demoMode = true;
            apiKey = null;
            this.hideApiKeyModal();
            updateDiag('ia', 'Modo demo (sin IA real)', 'text-yellow-500');
            this.loadNotebooks();
            setTimeout(() => this.startAnyway(), 500);
        },

        loadNotebooks() {
            notebooks = mockData.notebooks;
            this.renderNotebooks();
        },

        startAnyway() {
            document.getElementById('setup-screen').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
            }, 500);
        },

        goHome() {
            activeNbId = null;
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
            window.scrollTo(0,0);
        },

        openNotebook(id, name) {
            activeNbId = id;
            document.getElementById('nb-title').innerText = name;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            
            pages = mockData.pages[id] || [];
            this.renderPages();
        },

        newNotebook() {
            const name = prompt("Nombre del cuaderno:");
            if (!name) return;
            
            const newNb = {
                id: 'nb-' + Date.now(),
                name: name,
                createdAt: new Date()
            };
            
            mockData.notebooks.push(newNb);
            mockData.pages[newNb.id] = [];
            this.loadNotebooks();
        },

        async processFiles(filesList) {
            if (!activeNbId) {
                alert('Por favor abre un cuaderno primero');
                return;
            }

            const files = Array.from(filesList);
            if (!files.length) return;

            document.getElementById('ia-overlay').classList.remove('hidden');
            document.getElementById('ia-tot').innerText = files.length;

            for (let i = 0; i < files.length; i++) {
                document.getElementById('ia-cur').innerText = i + 1;
                document.getElementById('ia-progress').style.width = ((i+1)/files.length * 100) + '%';
                
                try {
                    const b64 = await this.toBase64(files[i]);
                    const analysis = await this.callIA(b64.split(',')[1]);
                    this.savePage(analysis, b64);
                } catch (e) { 
                    console.error(e);
                    alert('Error procesando imagen: ' + e.message);
                }
            }
            
            document.getElementById('ia-overlay').classList.add('hidden');
            this.renderPages();
        },

        async callIA(base64) {
            if (demoMode || !apiKey) {
                // Modo demo
                await new Promise(r => setTimeout(r, 1500));
                return {
                    texto: `# P√°gina escaneada\n\nContenido extra√≠do de la imagen. **Modo demo activo** - configura tu API Key para usar IA real.\n\n- Punto de ejemplo 1\n- Punto de ejemplo 2\n- Punto de ejemplo 3`,
                    mermaid: 'graph LR\n    A[Demo] --> B[Configura]\n    B --> C[API Key]'
                };
            }

            const prompt = "Extrae TODO el texto visible en esta imagen y convi√©rtelo a Markdown. Si hay dibujos, diagramas o esquemas, descr√≠belos y convi√©rtelos a c√≥digo Mermaid.js cuando sea posible. Devuelve un JSON con este formato exacto: {\"texto\": \"contenido en markdown\", \"mermaid\": \"c√≥digo mermaid si aplica o cadena vac√≠a\"}";
            
            // Lista de modelos a probar - empezando con el m√°s reciente
            const modelos = [
                'gemini-2.0-flash-exp',           // √öltimo modelo experimental
                'gemini-2.0-flash-thinking-exp',  // Con capacidad de razonamiento
                'gemini-1.5-flash-latest',        // Respaldo estable
                'gemini-1.5-flash',               // Respaldo
                'gemini-1.5-pro-latest'           // M√°s potente si los otros fallan
            ];
            
            let lastError = null;
            
            // Intentar con diferentes modelos
            for (const modelo of modelos) {
                try {
                    console.log('üîÑ Intentando con modelo:', modelo);
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ 
                                parts: [
                                    { text: prompt }, 
                                    { inlineData: { mimeType: "image/jpeg", data: base64 } }
                                ] 
                            }],
                            generationConfig: { 
                                responseMimeType: "application/json",
                                temperature: 0.2
                            }
                        })
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        console.log('‚úÖ √âxito con modelo:', modelo);
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        return result;
                    }
                    
                    const errorText = await res.text();
                    lastError = `${modelo}: ${res.status} - ${errorText.substring(0, 100)}`;
                    console.log('‚ùå Fall√≥ modelo:', modelo, 'Status:', res.status);
                    
                    // Si es rate limit, esperar un poco antes del siguiente intento
                    if (res.status === 429) {
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    
                } catch (e) {
                    lastError = e.message;
                    console.log('‚ùå Error con modelo:', modelo, e.message);
                }
            }
            
            // Si ning√∫n modelo funcion√≥
            throw new Error(`No se pudo procesar la imagen con ning√∫n modelo. √öltimo error: ${lastError}`);
        },

        savePage(res, img) {
            if (!mockData.pages[activeNbId]) {
                mockData.pages[activeNbId] = [];
            }
            
            const newPage = {
                id: 'page-' + Date.now(),
                texto: res.texto || "Sin texto extra√≠do",
                mermaid: res.mermaid || "",
                imageUrl: img,
                createdAt: new Date()
            };
            
            mockData.pages[activeNbId].unshift(newPage);
            pages = mockData.pages[activeNbId];
        },

        renderNotebooks() {
            const cont = document.getElementById('notebooks-grid');
            if (!notebooks.length) {
                cont.innerHTML = `<div class="p-12 text-center text-slate-400">No hay cuadernos a√∫n. Crea uno nuevo con el bot√≥n +</div>`;
                return;
            }
            cont.innerHTML = notebooks.map(nb => `
                <div onclick="app.openNotebook('${nb.id}', '${nb.name}')" class="ios-card p-5 flex items-center justify-between btn-active cursor-pointer">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center font-bold text-2xl">üìì</div>
                        <span class="font-bold text-lg text-slate-800">${nb.name}</span>
                    </div>
                    <button onclick="app.deleteNb('${nb.id}', event)" class="p-2 text-red-400 hover:text-red-600">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
                    </button>
                </div>
            `).join('');
        },

        renderPages() {
            const cont = document.getElementById('pages-list');
            if (!pages.length) {
                cont.innerHTML = `<div class="p-12 text-center text-slate-400">No hay p√°ginas escaneadas. Usa los botones de abajo para capturar im√°genes.</div>`;
                return;
            }
            
            cont.innerHTML = pages.map(p => `
                <div class="ios-card overflow-hidden">
                    <img src="${p.imageUrl}" class="w-full h-48 object-cover border-b border-slate-50" alt="P√°gina escaneada">
                    <div class="p-6">
                        <div class="prose prose-sm text-slate-700 mb-6 max-w-none">${marked.parse(p.texto)}</div>
                        ${p.mermaid ? `<div class="bg-slate-50 p-4 rounded-xl overflow-x-auto mb-4"><pre class="mermaid">${p.mermaid}</pre></div>` : ''}
                        <div class="flex space-x-2">
                            <button onclick="app.share('${p.id}')" class="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-bold btn-active">Compartir</button>
                            <button onclick="app.deletePage('${p.id}')" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center btn-active">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            if (pages.some(p => p.mermaid)) {
                setTimeout(() => {
                    mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
                }, 100);
            }
        },

        deleteNb(id, e) { 
            e.stopPropagation(); 
            if(confirm("¬øBorrar este cuaderno?")) {
                mockData.notebooks = mockData.notebooks.filter(nb => nb.id !== id);
                delete mockData.pages[id];
                this.loadNotebooks();
            }
        },
        
        deletePage(id) { 
            if(confirm("¬øBorrar esta p√°gina?")) {
                mockData.pages[activeNbId] = mockData.pages[activeNbId].filter(p => p.id !== id);
                pages = mockData.pages[activeNbId];
                this.renderPages();
            }
        },
        
        share(id) { 
            const p = pages.find(x => x.id === id);
            if (p) {
                if(navigator.share) {
                    navigator.share({title:'Escaneo', text: p.texto});
                } else {
                    navigator.clipboard.writeText(p.texto);
                    alert("Texto copiado al portapapeles"); 
                }
            }
        },
        
        toBase64: (f) => new Promise(r => { 
            const rd = new FileReader(); 
            rd.onload = () => r(rd.result); 
            rd.readAsDataURL(f); 
        })
    };

    // Inicio
    mermaid.initialize({ startOnLoad: false, theme: 'default' });
    app.init();

</script>
```

</body>
</html>
