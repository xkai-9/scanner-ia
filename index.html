<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>NoteScan Local</title>

    <!-- Librerías de Estilo, IA y Matemáticas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { 
            background-color: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .ios-card { background: white; border-radius: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-active:active { transform: scale(0.96); opacity: 0.8; }
        .spinner { border: 3px solid rgba(0,0,0,0.05); border-top-color: var(--ios-blue); border-radius: 50%; width: 28px; height: 28px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .mermaid svg { width: 100% !important; height: auto !important; border-radius: 12px; background: white; padding: 12px; }
        .view { transition: all 0.3s ease; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .badge-local { background: #E3F2FD; color: #1976D2; font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 100px; display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- VISTA 1: BIBLIOTECA (Cuadernos) -->
    <div id="view-home" class="view min-h-screen pb-32">
        <header class="p-6 pt-16 space-y-4">
            <div class="flex justify-between items-start">
                <div>
                    <div class="badge-local mb-2">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.707 14.707a1 1 0 01-1.414-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4z"/></svg>
                        ALMACENAMIENTO LOCAL
                    </div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight">Mis Notas</h1>
                </div>
                <button onclick="ui.createNotebook()" class="bg-blue-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg btn-active">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
            <p class="text-slate-400 font-medium text-sm">Escaneos guardados solo en este iPhone.</p>
        </header>
        <div id="notebooks-list" class="px-6 space-y-4"></div>
    </div>

    <!-- VISTA 2: DETALLE DEL CUADERNO (Páginas) -->
    <div id="view-detail" class="view hidden min-h-screen pb-40">
        <nav class="sticky top-0 glass border-b border-slate-100 px-4 py-4 flex items-center justify-between z-50">
            <button onclick="ui.goHome()" class="text-blue-600 font-bold flex items-center btn-active">
                <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                Biblioteca
            </button>
            <h2 id="current-nb-title" class="font-bold truncate px-4 max-w-[180px]">Nombre</h2>
            <div class="w-10"></div>
        </nav>
        <div id="pages-list" class="p-4 space-y-6"></div>

        <!-- Acciones de Captura -->
        <div class="fixed bottom-0 left-0 right-0 p-6 glass border-t border-slate-200/50 flex space-x-3 safe-bottom z-40">
            <label class="flex-1 bg-white border border-slate-200 text-slate-700 h-14 rounded-2xl flex items-center justify-center font-bold shadow-sm btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Importar
                <input type="file" multiple accept="image/*" class="hidden" onchange="ia.batch(this.files)">
            </label>
            <label class="flex-1 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center font-bold shadow-xl btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
                Cámara
                <input type="file" capture="environment" accept="image/*" class="hidden" onchange="ia.batch(this.files)">
            </label>
        </div>
    </div>

    <!-- Overlay de Procesamiento IA -->
    <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[200] hidden flex items-center justify-center p-6 text-center text-white">
        <div class="bg-white text-slate-900 rounded-[32px] p-8 w-full max-w-xs space-y-4 shadow-2xl">
            <div class="spinner mx-auto !w-12 !h-12 !border-4"></div>
            <h3 class="font-bold text-xl">Digitalizando</h3>
            <p class="text-slate-400 text-sm">Procesando página <span id="p-cur">0</span> de <span id="p-tot">0</span></p>
            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                <div id="p-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">IA Procesando Manuscrito</p>
        </div>
    </div>

    <!-- Canvas para exportar figuras como imagen -->
    <canvas id="export-canvas" class="hidden"></canvas>

    <script>
        // --- CONSTANTES Y ESTADO ---
        const apiKey = ""; // La clave se provee automáticamente en el entorno
        const STORAGE_KEY = 'notescan_local_v1';
        
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { notebooks: [] };
        let activeNbId = null;

        const saveState = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

        // --- MOTOR IA ---
        window.ia = {
            async batch(files) {
                const list = Array.from(files);
                if (!list.length || !activeNbId) return;

                document.getElementById('overlay').classList.remove('hidden');
                document.getElementById('p-tot').innerText = list.length;

                for (let i = 0; i < list.length; i++) {
                    const cur = i + 1;
                    document.getElementById('p-cur').innerText = cur;
                    document.getElementById('p-bar').style.width = (cur / list.length * 100) + '%';
                    
                    try {
                        const b64 = await this.toBase64(list[i]);
                        const analysis = await this.analyze(b64.split(',')[1]);
                        this.savePage(analysis, b64);
                    } catch (e) { console.error("Error en página", i, e); }
                }
                document.getElementById('overlay').classList.add('hidden');
                ui.renderPages();
            },

            async analyze(b64) {
                const prompt = `Actúa como NoteScan Pro. Analiza el manuscrito:
                1. Texto: Extrae a Markdown profesional.
                2. Matemáticas: Usa LaTeX ($...$).
                3. Diagramas: Si hay esquemas, conviértelos a código Mermaid.js.
                Devuelve JSON estricto: {"texto": "...", "mermaid": "..."}`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: b64 } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!res.ok) throw new Error("Fallo en la IA");
                const data = await res.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            },

            savePage(res, img) {
                const nb = state.notebooks.find(n => n.id === activeNbId);
                nb.pages.unshift({
                    id: Date.now() + Math.random(),
                    texto: res.texto,
                    mermaid: res.mermaid || "",
                    imageUrl: img,
                    createdAt: new Date().toISOString()
                });
                saveState();
            },

            toBase64: (f) => new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); })
        };

        // --- INTERFAZ ---
        window.ui = {
            init() {
                this.renderNotebooks();
            },

            goHome() {
                activeNbId = null;
                document.getElementById('view-detail').classList.add('hidden');
                document.getElementById('view-home').classList.remove('hidden');
            },

            createNotebook() {
                const name = prompt("Nombre del nuevo cuaderno:");
                if (!name) return;
                state.notebooks.unshift({ id: Date.now(), name, pages: [] });
                saveState();
                this.renderNotebooks();
            },

            openNotebook(id, name) {
                activeNbId = id;
                document.getElementById('current-nb-title').innerText = name;
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-detail').classList.remove('hidden');
                this.renderPages();
            },

            renderNotebooks() {
                const cont = document.getElementById('notebooks-list');
                if (!state.notebooks.length) {
                    cont.innerHTML = `<div class="p-12 text-center text-slate-400">Sin cuadernos creados.<br>Toca el botón (+) para empezar.</div>`;
                    return;
                }
                cont.innerHTML = state.notebooks.map(nb => `
                    <div onclick="ui.openNotebook(${nb.id}, '${nb.name}')" class="ios-card p-6 flex items-center justify-between btn-active">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center font-bold">NB</div>
                            <div>
                                <h3 class="font-bold text-lg">${nb.name}</h3>
                                <p class="text-xs text-slate-400">${nb.pages.length} páginas</p>
                            </div>
                        </div>
                        <button onclick="ui.deleteNotebook(${nb.id}, event)" class="p-2 text-slate-200 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                `).join('');
            },

            renderPages() {
                const cont = document.getElementById('pages-list');
                const nb = state.notebooks.find(n => n.id === activeNbId);
                if (!nb.pages.length) {
                    cont.innerHTML = `<div class="py-20 text-center text-slate-400">Escanea una hoja para este cuaderno.</div>`;
                    return;
                }
                cont.innerHTML = nb.pages.map(p => `
                    <div id="page-${p.id}" class="ios-card overflow-hidden">
                        <img src="${p.imageUrl}" class="w-full h-32 object-cover opacity-60">
                        <div class="p-6">
                            <div class="prose prose-sm text-slate-700 mb-6">
                                ${marked.parse(p.texto)}
                            </div>
                            ${p.mermaid ? `<div class="bg-slate-50 p-4 rounded-2xl mb-6 overflow-x-auto"><pre class="mermaid">${p.mermaid}</pre></div>` : ''}
                            <div class="flex space-x-2">
                                <button onclick="ui.sharePro('${p.id}')" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold btn-active">Compartir con Figura</button>
                                <button onclick="ui.deletePage(${p.id})" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center btn-active">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                renderMathInElement(cont, { delimiters: [{left: "$", right: "$", display: false}, {left: "$$", right: "$$", display: true}] });
                if (nb.pages.some(p => p.mermaid)) mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
            },

            async sharePro(id) {
                const nb = state.notebooks.find(n => n.id === activeNbId);
                const p = nb.pages.find(pg => pg.id == id);
                const container = document.getElementById(`page-${id}`);
                const svg = container.querySelector('.mermaid svg');
                
                let shareFiles = [];
                if (svg) {
                    try {
                        const blob = await this.svgToBlob(svg);
                        shareFiles.push(new File([blob], "esquema.png", {type: "image/png"}));
                    } catch (e) { console.error("Error al exportar figura:", e); }
                }

                if (navigator.share) {
                    const data = { title: 'NoteScan Local', text: p.texto };
                    if (shareFiles.length && navigator.canShare && navigator.canShare({files: shareFiles})) {
                        data.files = shareFiles;
                    }
                    await navigator.share(data);
                } else {
                    alert("Copiado.");
                }
            },

            svgToBlob(svg) {
                return new Promise(r => {
                    const canvas = document.getElementById('export-canvas');
                    const ctx = canvas.getContext('2d');
                    const data = new XMLSerializer().serializeToString(svg);
                    const img = new Image();
                    const blob = new Blob([data], {type: "image/svg+xml;charset=utf-8"});
                    const url = URL.createObjectURL(blob);
                    img.onload = () => {
                        canvas.width = img.width * 2; canvas.height = img.height * 2;
                        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        URL.revokeObjectURL(url);
                        canvas.toBlob(r);
                    };
                    img.src = url;
                });
            },

            deleteNotebook(id, e) {
                e.stopPropagation();
                if (confirm("¿Borrar este cuaderno y sus páginas?")) {
                    state.notebooks = state.notebooks.filter(n => n.id !== id);
                    saveState();
                    this.renderNotebooks();
                }
            },

            deletePage(id) {
                if (confirm("¿Borrar esta página?")) {
                    const nb = state.notebooks.find(n => n.id === activeNbId);
                    nb.pages = nb.pages.filter(p => p.id !== id);
                    saveState();
                    this.renderPages();
                }
            }
        };

        // --- INIT ---
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
        ui.init();
    </script>
</body>
</html>
