<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Scanner IA Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { 
            background-color: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-active:active { transform: scale(0.96); opacity: 0.8; }
        .spinner { border: 3px solid rgba(0,0,0,0.05); border-top-color: var(--ios-blue); border-radius: 50%; width: 28px; height: 28px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .mermaid svg { width: 100% !important; height: auto !important; border-radius: 12px; background: white; padding: 10px; }
        .view { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="text-slate-900 pb-10">

    <!-- Pantalla de Configuración API -->
    <div id="api-screen" class="fixed inset-0 bg-white z-[300] hidden flex flex-col items-center justify-center p-8 text-center">
        <h2 class="text-3xl font-black mb-4 tracking-tight">Activar Escáner</h2>
        <input type="password" id="api-input" placeholder="Pega tu API Key de Gemini" class="w-full max-w-sm p-5 bg-slate-100 rounded-2xl mb-4 text-center outline-none ring-blue-500 focus:ring-2">
        <button onclick="app.saveKey()" class="w-full max-w-sm bg-blue-600 text-white py-4 rounded-2xl font-bold btn-active">Configurar</button>
    </div>

    <!-- VISTA 1: LISTA DE CUADERNOS -->
    <div id="view-home" class="view min-h-screen">
        <header class="p-6 pt-16 flex justify-between items-end">
            <div>
                <p class="text-blue-600 font-bold text-xs uppercase tracking-widest mb-1">Tu Biblioteca</p>
                <h1 class="text-4xl font-black text-slate-800">Cuadernos</h1>
            </div>
            <button onclick="ui.promptNewNotebook()" class="bg-blue-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg btn-active">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
            </button>
        </header>
        <div id="notebooks-list" class="px-6 space-y-4"></div>
    </div>

    <!-- VISTA 2: DENTRO DEL CUADERNO -->
    <div id="view-detail" class="view hidden min-h-screen pb-40">
        <nav class="sticky top-0 glass border-b border-slate-100 px-4 py-4 flex items-center justify-between z-50">
            <button onclick="ui.goHome()" class="text-blue-600 font-bold flex items-center btn-active">
                <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                Biblioteca
            </button>
            <h2 id="current-notebook-title" class="font-bold truncate px-4 max-w-[150px]">Nombre</h2>
            <div class="w-10"></div>
        </nav>
        <div id="pages-list" class="p-4 space-y-6"></div>
        
        <!-- Acciones de captura -->
        <div class="fixed bottom-0 left-0 right-0 p-6 glass border-t border-slate-200/50 flex space-x-3 pb-10 z-40">
            <label class="flex-1 bg-white border border-slate-200 text-slate-700 h-14 rounded-2xl flex items-center justify-center font-bold shadow-sm btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Galería
                <input type="file" multiple accept="image/*" class="hidden" onchange="ia.batch(this.files)">
            </label>
            <label class="flex-1 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center font-bold shadow-xl btn-active cursor-pointer">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
                Cámara
                <input type="file" capture="environment" accept="image/*" class="hidden" onchange="ia.batch(this.files)">
            </label>
        </div>
    </div>

    <!-- Pantalla Procesando -->
    <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[400] hidden flex items-center justify-center p-6 text-center text-white">
        <div class="bg-white text-slate-900 rounded-[32px] p-8 w-full max-w-xs space-y-4">
            <div class="spinner mx-auto !w-12 !h-12 !border-4"></div>
            <h3 class="font-bold text-xl">Digitalizando...</h3>
            <p class="text-slate-400 text-sm">Página <span id="p-cur">0</span> de <span id="p-tot">0</span></p>
            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                <div id="p-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <!-- Canvas oculto para conversión de imagen -->
    <canvas id="export-canvas" class="hidden"></canvas>

    <script>
        // --- STORAGE ---
        let state = JSON.parse(localStorage.getItem('scanner_pro_v6') || '{"notebooks":[]}');
        let apiKey = localStorage.getItem('scanner_api_key') || "";
        let currentNbId = null;

        const save = () => localStorage.setItem('scanner_pro_v6', JSON.stringify(state));

        // --- IA MOTOR ---
        window.ia = {
            async batch(filesList) {
                const files = Array.from(filesList);
                if (!files.length || !currentNbId) return;

                document.getElementById('overlay').classList.remove('hidden');
                document.getElementById('p-tot').innerText = files.length;

                for (let i = 0; i < files.length; i++) {
                    const cur = i + 1;
                    document.getElementById('p-cur').innerText = cur;
                    document.getElementById('p-bar').style.width = (cur / files.length * 100) + '%';
                    
                    try {
                        const b64 = await this.toBase64(files[i]);
                        const analysis = await this.analyze(b64.split(',')[1]);
                        this.savePage(analysis, b64);
                    } catch (e) { console.error(e); }
                }
                document.getElementById('overlay').classList.add('hidden');
                ui.renderPages();
            },

            async analyze(b64) {
                const prompt = "Analiza el escaneo: 1. Extrae texto a Markdown. 2. Si hay dibujos, diagramas o esquemas, conviértelos a código Mermaid.js preciso. Devuelve JSON: {'texto': '...', 'mermaid': '...'}";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: b64 } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await res.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            },

            savePage(res, img) {
                const nb = state.notebooks.find(n => n.id === currentNbId);
                nb.pages.unshift({
                    id: Date.now() + Math.random(),
                    texto: res.texto,
                    mermaid: res.mermaid || "",
                    image: img,
                    timestamp: new Date().toLocaleString()
                });
                save();
            },

            toBase64: (f) => new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); })
        };

        // --- UI ---
        window.ui = {
            init() {
                if (!apiKey) document.getElementById('api-screen').classList.remove('hidden');
                else this.renderNotebooks();
            },

            goHome() {
                currentNbId = null;
                document.getElementById('view-detail').classList.add('hidden');
                document.getElementById('view-home').classList.remove('hidden');
                this.renderNotebooks();
            },

            promptNewNotebook() {
                const name = prompt("Nombre del cuaderno:");
                if (!name) return;
                state.notebooks.unshift({ id: Date.now(), name, pages: [] });
                save();
                this.renderNotebooks();
            },

            openNotebook(id) {
                currentNbId = id;
                const nb = state.notebooks.find(n => n.id === id);
                document.getElementById('current-notebook-title').innerText = nb.name;
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-detail').classList.remove('hidden');
                this.renderPages();
            },

            renderNotebooks() {
                const cont = document.getElementById('notebooks-list');
                if (!state.notebooks.length) {
                    cont.innerHTML = `<div class="py-20 text-center text-slate-400">Sin cuadernos creados.</div>`;
                    return;
                }
                cont.innerHTML = state.notebooks.map(nb => `
                    <div onclick="ui.openNotebook(${nb.id})" class="ios-card p-5 flex justify-between items-center btn-active">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center font-bold">NB</div>
                            <div>
                                <h3 class="font-bold text-lg">${nb.name}</h3>
                                <p class="text-xs text-slate-400">${nb.pages.length} páginas</p>
                            </div>
                        </div>
                        <button onclick="ui.deleteNotebook(${nb.id}, event)" class="text-slate-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
                        </button>
                    </div>
                `).join('');
            },

            renderPages() {
                const cont = document.getElementById('pages-list');
                const nb = state.notebooks.find(n => n.id === currentNbId);
                if (!nb.pages.length) {
                    cont.innerHTML = `<div class="py-20 text-center text-slate-400">Escanea una hoja para empezar.</div>`;
                    return;
                }
                cont.innerHTML = nb.pages.map(p => `
                    <div id="page-${p.id}" class="ios-card overflow-hidden">
                        <img src="${p.image}" class="w-full h-32 object-cover opacity-60 grayscale">
                        <div class="p-6">
                            <div class="prose prose-sm text-slate-700 mb-6">${marked.parse(p.texto)}</div>
                            ${p.mermaid ? `
                                <div class="mb-4">
                                    <div class="mermaid-container bg-slate-50 p-4 rounded-2xl overflow-x-auto relative">
                                        <pre class="mermaid">${p.mermaid}</pre>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex space-x-2">
                                <button onclick="ui.sharePro('${p.id}')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold btn-active">Compartir con Figuras</button>
                                <button onclick="ui.deletePage('${p.id}')" class="w-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center btn-press"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            </div>
                        </div>
                    </div>
                `).join('');
                if (nb.pages.some(p => p.mermaid)) mermaid.run();
            },

            async sharePro(pageId) {
                const nb = state.notebooks.find(n => n.id === currentNbId);
                const p = nb.pages.find(pg => pg.id == pageId);
                const container = document.querySelector(`#page-${pageId}`);
                const svg = container.querySelector('.mermaid svg');

                let files = [];
                
                // Si hay diagrama, convertirlo a imagen para compartir
                if (svg) {
                    try {
                        const blob = await this.svgToBlob(svg);
                        const file = new File([blob], "diagrama.png", { type: "image/png" });
                        files.push(file);
                    } catch (e) { console.error("Error al convertir figura:", e); }
                }

                if (navigator.share) {
                    try {
                        const shareData = {
                            title: 'Escaneo IA Pro',
                            text: p.texto
                        };
                        // Solo añadimos files si el navegador lo soporta (iOS lo hace)
                        if (files.length > 0 && navigator.canShare && navigator.canShare({ files })) {
                            shareData.files = files;
                        }
                        await navigator.share(shareData);
                    } catch (e) { console.error(e); }
                } else {
                    alert("Copiado al portapapeles. (Tu navegador no soporta compartir imágenes directamente)");
                }
            },

            svgToBlob(svg) {
                return new Promise((resolve) => {
                    const canvas = document.getElementById('export-canvas');
                    const ctx = canvas.getContext('2d');
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const img = new Image();
                    const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
                    const url = URL.createObjectURL(svgBlob);

                    img.onload = () => {
                        canvas.width = img.width * 2; // Alta resolución
                        canvas.height = img.height * 2;
                        ctx.fillStyle = "white";
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        URL.revokeObjectURL(url);
                        canvas.toBlob(resolve, "image/png");
                    };
                    img.src = url;
                });
            },

            deleteNotebook(id, e) {
                e.stopPropagation();
                if(confirm("¿Borrar cuaderno y todo su contenido?")) {
                    state.notebooks = state.notebooks.filter(n => n.id !== id);
                    save();
                    this.renderNotebooks();
                }
            },

            deletePage(id) {
                if(confirm("¿Borrar página?")) {
                    const nb = state.notebooks.find(n => n.id === currentNbId);
                    nb.pages = nb.pages.filter(p => p.id !== id);
                    save();
                    this.renderPages();
                }
            }
        };

        window.app = {
            saveKey() {
                const val = document.getElementById('api-input').value.trim();
                if (val.length < 20) return alert("Llave no válida");
                apiKey = val;
                localStorage.setItem('scanner_api_key', val);
                document.getElementById('api-screen').classList.add('hidden');
                ui.renderNotebooks();
            }
        };

        mermaid.initialize({ startOnLoad: false, theme: 'default' });
        ui.init();
    </script>
</body>
</html>
